# n8n Cloudへの自動デプロイワークフロー（Infisical使用版）
#
# このワークフローは、Infisicalを使用してn8n Cloudにワークフローをデプロイする例です。
# 実際に使用する場合は、このファイルをコピーして適切な名前（例: deploy-to-n8n.yml）にリネームしてください。
#
# 前提条件:
# 1. Infisicalアカウントとプロジェクトが作成されていること
# 2. GitHub Secretsに以下が設定されていること:
#    - INFISICAL_TOKEN: Infisicalサービストークン
#    - INFISICAL_PROJECT_ID: InfisicalプロジェクトID（オプション）
# 3. Infisicalに以下のシークレットが設定されていること:
#    - N8N_API_KEY: n8n Cloud APIキー
#    - N8N_API_URL: n8n CloudインスタンスのURL
#
# 設定方法: docs/infisical-setup.md を参照

name: Deploy to n8n Cloud (Infisical)

on:
  # 手動実行
  workflow_dispatch:
    inputs:
      workflow_file:
        description: 'デプロイするワークフローファイル（workflows/からの相対パス）'
        required: true
        type: string
        default: 'manual-hello-world-test.json'
      environment:
        description: 'Infisical環境（development/staging/production）'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
        default: 'production'

  # または、特定のブランチへのpush時に自動実行
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'workflows/**/*.json'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Format workflow JSON
        run: npm run format

      - name: Validate workflow JSON
        run: npm run format:check

      # 方法1: Infisical Actionを使用（推奨）
      - name: Load secrets from Infisical
        uses: infisical/get-secrets@v2.2.0
        with:
          path: ./.env
          env-slug: ${{ github.event.inputs.environment || 'production' }}
          infisical-token: ${{ secrets.INFISICAL_TOKEN }}
          project-id: ${{ secrets.INFISICAL_PROJECT_ID }}

      - name: Deploy workflow to n8n Cloud
        env:
          N8N_API_URL: ${{ secrets.N8N_API_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          # .envファイルから環境変数を読み込む
          set -a
          source .env
          set +a

          # ワークフローファイルのパスを設定
          WORKFLOW_FILE="workflows/${{ github.event.inputs.workflow_file }}"

          # ファイルの存在確認
          if [ ! -f "$WORKFLOW_FILE" ]; then
            echo "Error: Workflow file not found: $WORKFLOW_FILE"
            exit 1
          fi

          # ワークフローJSONを読み込む
          WORKFLOW_JSON=$(cat "$WORKFLOW_FILE")

          # n8n APIを使用してワークフローをインポート
          # 注意: この例は基本的な実装です。実際のn8n APIの仕様に合わせて調整してください
          echo "Deploying workflow: $WORKFLOW_FILE"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"

          # n8n APIへのリクエスト例（実際のAPIエンドポイントに合わせて調整が必要）
          # curl -X POST "$N8N_API_URL/api/v1/workflows" \
          #   -H "X-N8N-API-KEY: $N8N_API_KEY" \
          #   -H "Content-Type: application/json" \
          #   -d "$WORKFLOW_JSON"

          echo "✅ Workflow deployment completed (example - actual API call needs to be implemented)"

      - name: Verify deployment
        env:
          N8N_API_URL: ${{ secrets.N8N_API_URL }}
          N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
        run: |
          echo "Verifying deployment..."
          # 実際の検証ロジックを実装
          # 例: ワークフローが正しくデプロイされたか確認












